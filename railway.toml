[build]
builder = "NIXPACKS"
buildCommand = "npm install"
# Forza l'uso di npm invece di bun
[build.environment]
NIXPACKS_PKG_MGR = "npm"

[deploy]
startCommand = "npm run dev"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[environments.production]
[environments.production.deploy]
# Avvia PostgreSQL in background, poi setup database e server
startCommand = "bash -c 'if [ -d \"/var/lib/postgresql/data\" ]; then (./scripts/start-postgres.sh &) && sleep 5; fi && npm run build && npm run setup:db && node scripts/start-server-with-api.js'"
